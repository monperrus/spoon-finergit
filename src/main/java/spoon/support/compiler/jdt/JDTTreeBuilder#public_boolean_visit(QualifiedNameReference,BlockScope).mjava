@Override
public
boolean
visit
(
QualifiedNameReference
qualifiedNameReference
,
BlockScope
scope
)
{
long
[
]
positions
=
qualifiedNameReference
.
sourcePositions
;
int
sourceStart
=
qualifiedNameReference
.
sourceStart
(
)
;
int
sourceEnd
=
qualifiedNameReference
.
sourceEnd
(
)
;
if
(
qualifiedNameReference
.
indexOfFirstFieldBinding
<
positions
.
length
)
{
sourceEnd
=
(
int
)
(
positions
[
qualifiedNameReference
.
indexOfFirstFieldBinding
]
>>>
32
)
-
2
;
}
if
(
qualifiedNameReference
.
binding
instanceof
FieldBinding
)
{
CtFieldAccess
<
Object
>
fa
;
if
(
context
.
stack
.
peek
(
)
.
element
instanceof
CtAssignment
&&
(
qualifiedNameReference
.
otherBindings
==
null
||
qualifiedNameReference
.
otherBindings
.
length
==
0
)
&&
context
.
assigned
)
{
fa
=
factory
.
Core
(
)
.
createFieldWrite
(
)
;
}
else
{
fa
=
factory
.
Core
(
)
.
createFieldRead
(
)
;
}
CtFieldReference
<
Object
>
ref
=
references
.
getVariableReference
(
qualifiedNameReference
.
fieldBinding
(
)
)
;
ref
.
setPosition
(
this
.
position
.
buildPosition
(
sourceStart
,
sourceEnd
)
)
;
if
(
ref
.
isStatic
(
)
)
{
final
TypeBinding
receiverType
=
qualifiedNameReference
.
actualReceiverType
;
if
(
receiverType
!=
null
)
{
final
CtTypeReference
<
Object
>
qualifiedRef
=
this
.
references
.
getQualifiedTypeReference
(
qualifiedNameReference
.
tokens
,
receiverType
,
qualifiedNameReference
.
fieldBinding
(
)
.
declaringClass
.
enclosingType
(
)
,
new
OnAccessListener
(
)
{
@Override
public
boolean
onAccess
(
char
[
]
[
]
tokens
,
int
index
)
{
return
!
CharOperation
.
equals
(
tokens
[
index
+
1
]
,
tokens
[
tokens
.
length
-
1
]
)
;
}
}
)
;
if
(
qualifiedRef
!=
null
)
{
ref
.
setDeclaringType
(
qualifiedRef
)
;
}
else
{
ref
.
setDeclaringType
(
references
.
getTypeReference
(
receiverType
)
)
;
}
}
CtTypeAccess
<
?
>
typeAccess
=
factory
.
Code
(
)
.
createTypeAccess
(
ref
.
getDeclaringType
(
)
)
;
if
(
qualifiedNameReference
.
indexOfFirstFieldBinding
>
1
)
{
sourceStart
=
qualifiedNameReference
.
sourceStart
(
)
;
sourceEnd
=
(
int
)
(
positions
[
qualifiedNameReference
.
indexOfFirstFieldBinding
-
1
]
>>>
32
)
-
2
;
typeAccess
.
setPosition
(
this
.
position
.
buildPosition
(
sourceStart
,
sourceEnd
)
)
;
}
else
{
typeAccess
.
setImplicit
(
true
)
;
}
fa
.
setTarget
(
typeAccess
)
;
}
else
if
(
!
ref
.
isStatic
(
)
&&
!
ref
.
getDeclaringType
(
)
.
isAnonymous
(
)
)
{
final
CtTypeReference
<
Object
>
type
=
references
.
getTypeReference
(
qualifiedNameReference
.
actualReceiverType
)
;
final
CtThisAccess
<
?
>
thisAccess
=
factory
.
Code
(
)
.
createThisAccess
(
type
)
;
thisAccess
.
setTarget
(
factory
.
Code
(
)
.
createTypeAccess
(
type
)
)
;
thisAccess
.
setImplicit
(
true
)
;
(
(
CtFieldAccess
)
fa
)
.
setTarget
(
thisAccess
)
;
}
fa
.
setVariable
(
ref
)
;
if
(
qualifiedNameReference
.
binding
!=
null
&&
!
(
(
FieldBinding
)
qualifiedNameReference
.
binding
)
.
declaringClass
.
isAnonymousType
(
)
&&
qualifiedNameReference
.
tokens
.
length
-
1
==
(
(
FieldBinding
)
qualifiedNameReference
.
binding
)
.
declaringClass
.
compoundName
.
length
&&
CharOperation
.
equals
(
CharOperation
.
subarray
(
qualifiedNameReference
.
tokens
,
0
,
qualifiedNameReference
.
tokens
.
length
-
1
)
,
(
(
FieldBinding
)
qualifiedNameReference
.
binding
)
.
declaringClass
.
compoundName
)
)
{
final
ReferenceBinding
declaringClass
=
(
(
FieldBinding
)
qualifiedNameReference
.
binding
)
.
declaringClass
;
final
CtTypeReference
<
Object
>
typeReference
=
references
.
getTypeReference
(
declaringClass
)
;
final
CtTypeAccess
<
Object
>
typeAccess
=
factory
.
Code
(
)
.
createTypeAccess
(
typeReference
)
;
sourceStart
=
qualifiedNameReference
.
sourceStart
(
)
;
sourceEnd
=
(
int
)
(
positions
[
qualifiedNameReference
.
indexOfFirstFieldBinding
-
1
]
>>>
32
)
-
2
;
typeAccess
.
setPosition
(
this
.
position
.
buildPosition
(
sourceStart
,
sourceEnd
)
)
;
fa
.
setTarget
(
typeAccess
)
;
}
if
(
qualifiedNameReference
.
otherBindings
!=
null
)
{
int
i
=
0
;
fa
.
setPosition
(
ref
.
getPosition
(
)
)
;
sourceStart
=
(
int
)
(
positions
[
qualifiedNameReference
.
indexOfFirstFieldBinding
-
1
]
>>>
32
)
;
for
(
FieldBinding
b
:
qualifiedNameReference
.
otherBindings
)
{
CtFieldAccess
<
Object
>
other
;
if
(
qualifiedNameReference
.
otherBindings
.
length
==
i
+
1
&&
context
.
stack
.
peek
(
)
.
element
instanceof
CtAssignment
&&
context
.
assigned
)
{
other
=
factory
.
Core
(
)
.
createFieldWrite
(
)
;
}
else
{
other
=
factory
.
Core
(
)
.
createFieldRead
(
)
;
}
other
.
setVariable
(
references
.
getVariableReference
(
b
)
)
;
other
.
setTarget
(
fa
)
;
if
(
b
!=
null
)
{
other
.
setType
(
references
.
getTypeReference
(
b
.
type
)
)
;
}
else
{
CtTypeReference
<
Object
>
ref2
=
factory
.
Core
(
)
.
createTypeReference
(
)
;
ref2
.
setSimpleName
(
new
String
(
qualifiedNameReference
.
tokens
[
i
+
1
]
)
)
;
other
.
getVariable
(
)
.
setSimpleName
(
ref2
.
getSimpleName
(
)
)
;
other
.
setType
(
ref2
)
;
}
if
(
i
+
qualifiedNameReference
.
indexOfFirstFieldBinding
>=
qualifiedNameReference
.
otherBindings
.
length
)
{
sourceEnd
=
qualifiedNameReference
.
sourceEnd
(
)
;
}
else
{
sourceEnd
=
(
int
)
(
positions
[
qualifiedNameReference
.
indexOfFirstFieldBinding
+
i
+
1
]
>>>
32
)
-
2
;
}
other
.
setPosition
(
this
.
position
.
buildPosition
(
sourceStart
,
sourceEnd
)
)
;
fa
=
other
;
i
++
;
}
}
fa
.
setPosition
(
this
.
position
.
buildPosition
(
qualifiedNameReference
.
sourceStart
(
)
,
qualifiedNameReference
.
sourceEnd
(
)
)
)
;
context
.
enter
(
fa
,
qualifiedNameReference
)
;
return
true
;
}
else
if
(
qualifiedNameReference
.
binding
instanceof
VariableBinding
)
{
CtVariableAccess
<
Object
>
va
;
if
(
context
.
stack
.
peek
(
)
.
element
instanceof
CtAssignment
&&
(
qualifiedNameReference
.
otherBindings
==
null
||
qualifiedNameReference
.
otherBindings
.
length
==
0
&&
context
.
assigned
)
)
{
va
=
factory
.
Core
(
)
.
createVariableWrite
(
)
;
}
else
{
va
=
factory
.
Core
(
)
.
createVariableRead
(
)
;
}
CtVariableReference
<
Object
>
varRef
=
references
.
getVariableReference
(
(
VariableBinding
)
qualifiedNameReference
.
binding
)
;
varRef
.
setPosition
(
this
.
position
.
buildPosition
(
sourceStart
,
sourceEnd
)
)
;
va
.
setVariable
(
varRef
)
;
va
.
setType
(
va
.
getVariable
(
)
.
getType
(
)
==
null
?
null
:
va
.
getVariable
(
)
.
getType
(
)
.
clone
(
)
)
;
if
(
qualifiedNameReference
.
otherBindings
!=
null
)
{
int
i
=
0
;
va
.
setPosition
(
varRef
.
getPosition
(
)
)
;
sourceStart
=
(
int
)
(
positions
[
qualifiedNameReference
.
indexOfFirstFieldBinding
-
1
]
>>>
32
)
;
for
(
FieldBinding
b
:
qualifiedNameReference
.
otherBindings
)
{
CtFieldAccess
<
Object
>
other
;
if
(
qualifiedNameReference
.
otherBindings
.
length
==
i
+
1
&&
context
.
stack
.
peek
(
)
.
element
instanceof
CtAssignment
)
{
other
=
factory
.
Core
(
)
.
createFieldWrite
(
)
;
}
else
{
other
=
factory
.
Core
(
)
.
createFieldRead
(
)
;
}
other
.
setVariable
(
references
.
getVariableReference
(
b
)
)
;
other
.
setTarget
(
va
)
;
if
(
b
!=
null
)
{
other
.
setType
(
references
.
getTypeReference
(
b
.
type
)
)
;
}
else
{
CtTypeReference
<
Object
>
ref
=
factory
.
Core
(
)
.
createTypeReference
(
)
;
ref
.
setSimpleName
(
new
String
(
qualifiedNameReference
.
tokens
[
qualifiedNameReference
.
tokens
.
length
-
1
]
)
)
;
other
.
setType
(
ref
)
;
}
if
(
i
+
qualifiedNameReference
.
indexOfFirstFieldBinding
>=
qualifiedNameReference
.
otherBindings
.
length
)
{
sourceEnd
=
qualifiedNameReference
.
sourceEnd
(
)
;
}
else
{
sourceEnd
=
(
int
)
(
positions
[
qualifiedNameReference
.
indexOfFirstFieldBinding
+
1
+
i
]
>>>
32
)
-
2
;
}
other
.
setPosition
(
this
.
position
.
buildPosition
(
sourceStart
,
sourceEnd
)
)
;
va
=
other
;
i
++
;
}
}
va
.
setPosition
(
this
.
position
.
buildPosition
(
qualifiedNameReference
.
sourceStart
(
)
,
qualifiedNameReference
.
sourceEnd
(
)
)
)
;
context
.
enter
(
va
,
qualifiedNameReference
)
;
return
false
;
}
else
if
(
qualifiedNameReference
.
binding
instanceof
TypeBinding
)
{
CtTypeAccess
<
Object
>
ta
=
factory
.
Code
(
)
.
createTypeAccessWithoutCloningReference
(
references
.
getTypeReference
(
(
TypeBinding
)
qualifiedNameReference
.
binding
)
)
;
context
.
enter
(
ta
,
qualifiedNameReference
)
;
return
false
;
}
else
if
(
qualifiedNameReference
.
binding
instanceof
ProblemBinding
)
{
CtVariableAccess
<
Object
>
va
;
if
(
context
.
stack
.
peek
(
)
.
element
instanceof
CtInvocation
)
{
final
CtTypeReference
<
Object
>
typeReference
=
factory
.
Core
(
)
.
createTypeReference
(
)
;
typeReference
.
setSimpleName
(
qualifiedNameReference
.
toString
(
)
)
;
final
CtTypeAccess
<
Object
>
ta
=
factory
.
Code
(
)
.
createTypeAccessWithoutCloningReference
(
typeReference
)
;
context
.
enter
(
ta
,
qualifiedNameReference
)
;
return
false
;
}
else
if
(
context
.
stack
.
peek
(
)
.
element
instanceof
CtAssignment
&&
context
.
assigned
)
{
va
=
factory
.
Core
(
)
.
createFieldWrite
(
)
;
}
else
{
va
=
factory
.
Core
(
)
.
createFieldRead
(
)
;
}
va
.
setVariable
(
references
.
getVariableReference
(
(
ProblemBinding
)
qualifiedNameReference
.
binding
)
)
;
if
(
va
.
getVariable
(
)
instanceof
CtFieldReference
)
{
final
char
[
]
[
]
declaringClass
=
CharOperation
.
subarray
(
qualifiedNameReference
.
tokens
,
0
,
qualifiedNameReference
.
tokens
.
length
-
1
)
;
final
MissingTypeBinding
declaringType
=
context
.
compilationunitdeclaration
.
scope
.
environment
.
createMissingType
(
null
,
declaringClass
)
;
final
CtTypeReference
<
Object
>
declaringRef
=
references
.
getTypeReference
(
declaringType
)
;
(
(
CtFieldReference
)
va
.
getVariable
(
)
)
.
setDeclaringType
(
declaringRef
)
;
(
(
CtFieldReference
)
va
.
getVariable
(
)
)
.
setStatic
(
true
)
;
(
(
CtFieldAccess
)
va
)
.
setTarget
(
factory
.
Code
(
)
.
createTypeAccess
(
declaringRef
)
)
;
}
va
.
getVariable
(
)
.
setSimpleName
(
JDTTreeBuilderHelper
.
createTypeName
(
CharOperation
.
subarray
(
qualifiedNameReference
.
tokens
,
qualifiedNameReference
.
tokens
.
length
-
1
,
qualifiedNameReference
.
tokens
.
length
)
)
)
;
context
.
enter
(
va
,
qualifiedNameReference
)
;
return
false
;
}
else
{
CtVariableAccess
<
Object
>
va
=
null
;
if
(
context
.
stack
.
peek
(
)
.
element
instanceof
CtAssignment
&&
context
.
assigned
)
{
va
=
factory
.
Core
(
)
.
createVariableWrite
(
)
;
}
else
{
va
=
factory
.
Core
(
)
.
createVariableRead
(
)
;
}
CtVariableReference
<
Object
>
varRef
=
new
CtUnboundVariableReferenceImpl
<
>
(
)
;
varRef
.
setSimpleName
(
qualifiedNameReference
.
toString
(
)
)
;
va
.
setVariable
(
varRef
)
;
context
.
enter
(
va
,
qualifiedNameReference
)
;
return
false
;
}
}
