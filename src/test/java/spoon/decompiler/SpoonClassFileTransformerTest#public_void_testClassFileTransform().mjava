@Test
public
void
testClassFileTransform
(
)
throws
ClassNotFoundException
,
IllegalAccessException
,
InvocationTargetException
,
InstantiationException
,
NoSuchMethodException
,
IOException
{
FileUtils
.
deleteDirectory
(
TMP_DIR
)
;
TMP_DIR
.
mkdir
(
)
;
DECOMPILED_DIR
.
mkdir
(
)
;
CACHE_DIR
.
mkdir
(
)
;
RECOMPILED_DIR
.
mkdir
(
)
;
SpoonClassFileTransformer
transformer
=
new
SpoonClassFileTransformer
(
s
->
s
.
startsWith
(
"se/kth/castor"
)
,
type
->
type
.
getField
(
"transformed"
)
.
setAssignment
(
type
.
getFactory
(
)
.
createCodeSnippetExpression
(
"true"
)
)
,
DECOMPILED_DIR
.
getPath
(
)
,
CACHE_DIR
.
getPath
(
)
,
RECOMPILED_DIR
.
getPath
(
)
,
null
)
;
TransformingClassLoader
cl
=
new
TransformingClassLoader
(
transformer
,
CLASSES_DIR
.
getPath
(
)
+
"/"
)
;
Class
<
?
>
subjectClass
=
cl
.
loadClass
(
"se/kth/castor/TransformMe"
)
;
Constructor
<
?
>
constructor
=
subjectClass
.
getConstructor
(
)
;
Object
subject
=
constructor
.
newInstance
(
)
;
Method
isTransformed
=
subjectClass
.
getMethod
(
"isTransformed"
)
;
Object
transformed
=
isTransformed
.
invoke
(
subject
,
new
Object
[
]
{
}
)
;
assertTrue
(
(
Boolean
)
transformed
)
;
FileUtils
.
deleteDirectory
(
TMP_DIR
)
;
}
