/** 
 * When building an index against existing data in sstables, add the given partition to the index
 */
public
void
indexPartition
(
UnfilteredRowIterator
partition
,
OpOrder
.
Group
opGroup
,
Set
<
Index
>
indexes
,
int
nowInSec
)
{
if
(
!
indexes
.
isEmpty
(
)
)
{
DecoratedKey
key
=
partition
.
partitionKey
(
)
;
Set
<
Index
.
Indexer
>
indexers
=
indexes
.
stream
(
)
.
map
(
index
->
index
.
indexerFor
(
key
,
nowInSec
,
opGroup
,
IndexTransaction
.
Type
.
UPDATE
)
)
.
collect
(
Collectors
.
toSet
(
)
)
;
indexers
.
forEach
(
Index
.
Indexer
::
begin
)
;
try
(
RowIterator
filtered
=
UnfilteredRowIterators
.
filter
(
partition
,
nowInSec
)
)
{
if
(
!
filtered
.
staticRow
(
)
.
isEmpty
(
)
)
indexers
.
forEach
(
indexer
->
indexer
.
insertRow
(
filtered
.
staticRow
(
)
)
)
;
while
(
filtered
.
hasNext
(
)
)
{
Row
row
=
filtered
.
next
(
)
;
indexers
.
forEach
(
indexer
->
indexer
.
insertRow
(
row
)
)
;
}
}
indexers
.
forEach
(
Index
.
Indexer
::
finish
)
;
}
}
