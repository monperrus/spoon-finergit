private
void
registerCancellableTask
(
Task
task
)
{
CancellableTask
cancellableTask
=
(
CancellableTask
)
task
;
CancellableTaskHolder
holder
=
new
CancellableTaskHolder
(
cancellableTask
)
;
CancellableTaskHolder
oldHolder
=
cancellableTasks
.
put
(
task
.
getId
(
)
,
holder
)
;
assert
oldHolder
==
null
:
;
if
(
task
.
getParentTaskId
(
)
.
isSet
(
)
&&
banedParents
.
isEmpty
(
)
==
false
)
{
String
reason
=
banedParents
.
get
(
task
.
getParentTaskId
(
)
)
;
if
(
reason
!=
null
)
{
try
{
holder
.
cancel
(
reason
)
;
throw
new
IllegalStateException
(
"Task cancelled before it started: "
+
reason
)
;
}
finally
{
unregister
(
task
)
;
}
}
}
}
